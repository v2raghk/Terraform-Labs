Lab 08 Explicit Dependency using Depends On

In Terraform, depends_on is used to explicitly control the order in which resources are created or destroyed.
By default, Terraform automatically figures out dependencies based on references. Example, if a storage account uses a resource group 
named azurerm_resource_group.rg.name, Terraform knows the resource group must be created first.

However, sometimes Terraform cannot automatically detect the dependency, or you want to enforce a strict order. Thatâ€™s when depends_on comes in.

Below is the lab using explicit dependency depends_on

Providers.tf => 

terraform {
  required_providers {
    azurerm = {
      source = "hashicorp/azurerm"
      version = "~>4.36.0"
    }
  }
}

provider "azurerm" {
  # Configuration options
  features { }
}
 
Backend.tf =>

terraform {
    backend "azurerm" {
    resource_group_name   = "rg-remotebackend"
    storage_account_name  = "tfstateprod12343" 
    container_name        = "tfstate"
    key                   = "terraform.tfstate"
  }
}
 
Variables.tf =>

variable "rgname" {
  description = "Name of Resource Group"
  type        = string
}

variable "location" {
  description = "Azure region"
  type        = string
}

variable "storage_account_name" {
  description = "Name of Storage Account"
  type        = string
}

variable "container_name" {
  description = "Name of Blob Container"
  type        = string
}

variable "storage_account_tier" {
  description = "Storage account Tier (Standard or Premium)"
  type        = string
  default     = "Standard"
}

variable "storage_account_replication_type" {
  description = "Replication type for storage account (LRS, GRS)"
  type        = string
  default     = "LRS"
}

variable "environment" {
  description = "Environment tag for resources (dev, prod, staging)"
  type        = string
  default     = "staging"
}

variable "container_access_type" {
  description = "Access type for blob container (private, blob, container)"
  type        = string
  default     = "private"
}

variable "blob_name" {
  description = "Name of the blob file"
  type        = string
  default     = "example.txt"
}

variable "blob_type" {
  description = "Type of blob: Block, Append, or Page"
  type        = string
  default     = "Block"
}

variable "blob_source" {
  description = "Local path of the file to upload"
  type        = string
  default     = "C:/tflabs2/blobupload.txt"
}
 
Terraform.tfvars =>

rgname                           = "rg-prod"
location                         = "UK West"
storage_account_name             = "prodazstore101"
container_name                   = "storecontent"
storage_account_tier             = "Standard"
storage_account_replication_type = "LRS"
environment                      = "staging"
container_access_type            = "private"
blob_name                        = "data.txt"
blob_type                        = "Block"
blob_source                      = "C:/<path>"
 
Rg.tf =>

resource "azurerm_resource_group" "rg" {
  name     = var.rgname
  location = var.location
}
 
Store.tf =>

resource "azurerm_storage_account" "azstore" {
name = var.storage_account_name
resource_group_name = var.rgname
location = var.location
account_tier = var.storage_account_tier
account_replication_type = var.storage_account_replication_type
depends_on = [azurerm_resource_group.rg] # Explicit Dependency

tags = {
    environment = var.environment
 }
}

resource "azurerm_storage_container" "storecontainer" {
  name                  = var.container_name
  storage_account_id    = azurerm_storage_account.azstore.id
  container_access_type = var.container_access_type
depends_on = [ azurerm_storage_account.azstore ] # Explicit Dependency
}

resource "azurerm_storage_blob" "storeblob" {
  name                   = var.blob_name
  storage_account_name   = azurerm_storage_account.azstore.name
  storage_container_name = azurerm_storage_container.storecontainer.name
  type                   = var.blob_type
  source                 = var.blob_source

  depends_on = [ azurerm_storage_container.storecontainer ]
}
